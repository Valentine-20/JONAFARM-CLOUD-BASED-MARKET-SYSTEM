<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buyer Dashboard - JonaFarm Market</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .cart-float {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--primary);
      color: var(--white);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 100;
    }

    .cart-count {
      position: absolute;
      top: 0;
      right: 0;
      background: #ff4d4d;
      color: white;
      font-size: 0.75rem;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #modal-cart {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 101;
    }

    .modal-content {
      background: var(--white);
      max-width: 800px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>

<body class="dashboard-grid">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="JonaFarm-logo.png" alt="Logo" width="40">
      <h2 style="font-size: 1.2rem;">JonaFarm</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active">ðŸ›’ Marketplace</a>
      <a href="#" class="nav-item">ðŸ“œ My Orders</a>
      <a href="#" class="nav-item">ðŸ‘¤ Profile</a>
    </nav>
    <button class="btn btn-outline" style="color: white; border-color: white; margin-top: auto;"
      onclick="logout()">Logout</button>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="top-bar">
      <div>
        <h2>Fresh from the Farm</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">Direct access to quality produce with blockchain
          verification.</p>
      </div>
      <div id="user-info" style="font-weight: 600; color: var(--primary);"></div>
    </header>

    <!-- Product Grid -->
    <div class="portal-container" id="products"
      style="margin: 0; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
      <!-- Products inserted by JS -->
    </div>

    <!-- Checkout Section (Hidden until order check) -->
    <div id="checkout-section" style="display: none; margin-top: 40px;">
      <h3 style="margin-bottom: 20px; color: var(--primary);">Complete Your Order</h3>
      <div class="stat-card" style="max-width: 600px;">
        <div id="order-form">
          <input type="text" id="buyer-name" placeholder="Your Name" class="nav-item"
            style="width: 100%; background: #f0f0f0; color: #333; margin-bottom: 10px;" required>
          <input type="text" id="buyer-phone" placeholder="Phone Number" class="nav-item"
            style="width: 100%; background: #f0f0f0; color: #333; margin-bottom: 10px;" required>
          <textarea id="buyer-address" placeholder="Delivery Address" class="nav-item"
            style="width: 100%; background: #f0f0f0; color: #333; margin-bottom: 20px; height: 80px;"
            required></textarea>
          <button class="btn btn-primary" style="width: 100%;" id="place-order-btn">Confirm Order</button>
        </div>
      </div>
    </div>

    <!-- Payment Info (Modal or Section) -->
    <div id="payment-section" style="display: none; margin-top: 20px;">
      <div class="stat-card" style="border: 2px solid var(--primary); max-width: 600px;">
        <h3 style="color: var(--primary); margin-bottom: 15px;">Payment Instructions</h3>
        <div id="payment-details" style="margin-bottom: 20px; font-size: 0.95rem;"></div>
        <button class="btn btn-primary" style="width: 100%;" onclick="confirmPayment()">I Have Paid</button>
      </div>
    </div>
  </main>

  <!-- Cart Floating Button -->
  <div class="cart-float" onclick="toggleCart()">
    ðŸ›’
    <div class="cart-count" id="cart-count">0</div>
  </div>

  <!-- Cart Modal -->
  <div id="modal-cart" onclick="if(event.target === this) toggleCart()">
    <div class="modal-content">
      <h3 style="margin-bottom: 20px; color: var(--primary);">Your Shopping Cart</h3>
      <div class="table-container" id="cart-container">
        <!-- Cart items here -->
      </div>
      <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
        <h4 id="cart-total">Total: KSh 0</h4>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-outline" onclick="toggleCart()">Continue Shopping</button>
          <button class="btn btn-primary" onclick="proceedToCheckout()">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let cart = [];
    const loggedBuyer = JSON.parse(localStorage.getItem('buyer'));
    if (!loggedBuyer) {
      window.location.href = 'buyer-login.html';
    } else {
      document.getElementById('user-info').textContent = loggedBuyer.name;
      document.getElementById('buyer-name').value = loggedBuyer.name;
      document.getElementById('buyer-phone').value = loggedBuyer.phone || '';
    }

    function logout() {
      localStorage.removeItem('buyer');
      window.location.href = 'index.html';
    }

    async function loadProducts() {
      const res = await fetch('/products');
      const products = await res.json();
      const container = document.getElementById('products');
      container.innerHTML = '';

      products.forEach(p => {
        const card = document.createElement('div');
        card.className = 'role-card';
        card.style.padding = '20px';
        card.innerHTML = `
                    <img src="${p.image}" alt="${p.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 5px;">${p.name}</h3>
                    <p style="color: var(--primary); font-weight: 700; margin-bottom: 10px;">KSh ${p.price_ksh} / ${p.unit}</p>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">
                        Farmer: ${p.farmer_name || 'JonaFarm Member'}<br>
                        Available: ${p.quantity} ${p.unit}
                    </p>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="badge ${p.verified ? 'badge-success' : 'badge-warning'}">${p.verified ? 'Verified' : 'Pending'}</span>
                        <button class="btn btn-primary" style="padding: 8px 15px;" onclick="addToCart('${p.name}', ${p.price_ksh}, '${p.farmer_name || 'John'}', '${p.farmer_contact || '0712345678'}')">Add</button>
                    </div>
                `;
        container.appendChild(card);
      });
    }

    function addToCart(name, price, farmer_name, farmer_contact) {
      const existing = cart.find(item => item.name === name);
      if (existing) existing.quantity++;
      else cart.push({ name, price_ksh: price, quantity: 1, farmer_name, farmer_contact });
      updateCartUI();
    }

    function updateCartUI() {
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById('cart-count').textContent = count;

      const container = document.getElementById('cart-container');
      if (cart.length === 0) {
        container.innerHTML = '<p style="padding: 20px; text-align: center;">Your cart is empty.</p>';
        document.getElementById('cart-total').textContent = 'Total: KSh 0';
        return;
      }

      let html = `<table><thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Subtotal</th><th>Action</th></tr></thead><tbody>`;
      let total = 0;
      cart.forEach(item => {
        const sub = item.price_ksh * item.quantity;
        total += sub;
        html += `<tr>
                    <td>${item.name}<br><small>${item.farmer_name}</small></td>
                    <td>${item.price_ksh}</td>
                    <td>${item.quantity}</td>
                    <td>${sub}</td>
                    <td><button class="badge badge-danger" style="border:none; cursor:pointer;" onclick="removeFromCart('${item.name}')">Remove</button></td>
                </tr>`;
      });
      html += `</tbody></table>`;
      container.innerHTML = html;
      document.getElementById('cart-total').textContent = `Total: KSh ${total}`;
    }

    function removeFromCart(name) {
      cart = cart.filter(item => item.name !== name);
      updateCartUI();
    }

    function toggleCart() {
      const modal = document.getElementById('modal-cart');
      modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
    }

    function proceedToCheckout() {
      if (cart.length === 0) return alert('Cart is empty');
      toggleCart();
      document.getElementById('checkout-section').style.display = 'block';
      document.getElementById('checkout-section').scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('place-order-btn').addEventListener('click', async () => {
      const buyerName = document.getElementById('buyer-name').value.trim();
      const phone = document.getElementById('buyer-phone').value.trim();
      const address = document.getElementById('buyer-address').value.trim();

      if (!buyerName || !phone || !address || cart.length === 0) {
        alert('Please fill all details');
        return;
      }

      for (let item of cart) {
        await fetch('/orders/place', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            product: item.name,
            quantity: item.quantity,
            buyer: buyerName,
            phone,
            address,
            farmer: item.farmer_name,
            order_date: new Date().toISOString(),
            status: 'Pending'
          })
        });
      }

      let paymentInfo = `<strong>Order Summary:</strong><br><br>`;
      cart.forEach(item => {
        paymentInfo += `${item.name} x ${item.quantity} (Farmer: ${item.farmer_name} - ${item.farmer_contact})<br>`;
      });
      paymentInfo += `<br><strong>Total: KSh ${cart.reduce((sum, i) => sum + i.price_ksh * i.quantity, 0)}</strong><br><br>`;
      paymentInfo += `Please send payment to the farmer's contact above and click "I Have Paid".`;

      document.getElementById('payment-details').innerHTML = paymentInfo;
      document.getElementById('payment-section').style.display = 'block';
      document.getElementById('checkout-section').style.display = 'none';
    });

    function confirmPayment() {
      alert('Order Confirmed! Thank you for shopping with JonaFarm.');
      cart = [];
      updateCartUI();
      document.getElementById('payment-section').style.display = 'none';
    }

    loadProducts();
  </script>
</body>

</html>