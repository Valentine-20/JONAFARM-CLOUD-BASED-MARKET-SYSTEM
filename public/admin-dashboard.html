<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - JonaFarm Market</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="dashboard-grid">

  <!-- Sidebar -->
  <aside class="sidebar" style="background: #1f3c88;">
    <div class="sidebar-header">
      <img src="JonaFarm-logo.png" alt="Logo" width="40">
      <h2 style="font-size: 1.2rem;">Admin Panel</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active">üìà Analytics</a>
      <a href="#" class="nav-item">üì¶ Inventory</a>
      <a href="#" class="nav-item">üìú All Orders</a>
      <a href="#" class="nav-item">üõ°Ô∏è Guard Chain</a>
    </nav>
    <button class="btn btn-outline" style="color: white; border-color: white; margin-top: auto;"
      onclick="logout()">Logout</button>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="top-bar">
      <div>
        <h2 id="admin-name">Platform Administration</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">System-wide monitoring and resource management.</p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-outline" onclick="downloadReports()">Download CSV Report</button>
        <button class="btn btn-primary" onclick="openForm()">+ New Product</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <h4>Total Revenue</h4>
        <div class="value" id="total-revenue" style="color: #1f3c88;">KSh 0</div>
      </div>
      <div class="stat-card">
        <h4>Active Orders</h4>
        <div class="value" id="total-orders">0</div>
      </div>
      <div class="stat-card">
        <h4>Verification Rate</h4>
        <div class="value" id="verification-rate">0%</div>
      </div>
    </div>

    <!-- Inventory Management -->
    <h3 style="margin-bottom: 20px; color: #1f3c88;">Product Inventory</h3>
    <div class="table-container" style="margin-bottom: 40px;">
      <table id="products-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="products-body">
          <!-- Products inserted by JS -->
        </tbody>
      </table>
    </div>

    <!-- Orders Management -->
    <h3 style="margin-bottom: 20px; color: #1f3c88;">Global Orders</h3>
    <div class="table-container">
      <table id="orders-table">
        <thead>
          <tr>
            <th>Buyer</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="orders-body">
          <!-- Orders inserted by JS -->
        </tbody>
      </table>
    </div>
  </main>

  <!-- Product Modal -->
  <div id="productForm"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="modal-content" style="max-width: 400px; padding: 30px;">
      <h3 id="form-title" style="margin-bottom: 20px; color: #1f3c88;">Modify Product</h3>
      <input id="pname" placeholder="Name" class="nav-item"
        style="width: 100%; color: #333; border: 1px solid #ccc; margin-bottom: 10px;">
      <input id="pprice" placeholder="Price (KSh)" class="nav-item"
        style="width: 100%; color: #333; border: 1px solid #ccc; margin-bottom: 10px;">
      <input id="pqty" placeholder="Quantity" class="nav-item"
        style="width: 100%; color: #333; border: 1px solid #ccc; margin-bottom: 10px;">
      <input id="punit" placeholder="Unit (e.g. kg)" class="nav-item"
        style="width: 100%; color: #333; border: 1px solid #ccc; margin-bottom: 10px;">
      <label style="font-size: 0.8rem; color: var(--text-muted);">Product Image:</label>
      <input type="file" id="pimage" accept="image/*" style="margin-bottom: 20px; font-size: 0.8rem;">

      <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" id="save-btn" onclick="saveProduct()"
          style="background: #1f3c88; flex: 1;">Save</button>
        <button class="btn btn-primary" id="update-btn" onclick="updateProduct()"
          style="background: #1f3c88; flex: 1; display: none;">Update</button>
        <button class="btn btn-outline" onclick="closeForm()" style="flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let currentUpdateId = null;
    const admin = JSON.parse(localStorage.getItem('admin'));
    if (!admin) location.href = 'admin-login.html';
    document.getElementById('admin-name').textContent = "Admin: " + admin.username;

    function logout() { localStorage.removeItem('admin'); location.href = 'index.html'; }

    function openForm() {
      document.getElementById('productForm').style.display = 'block';
      document.getElementById('form-title').textContent = 'Add New Product';
      document.getElementById('save-btn').style.display = 'block';
      document.getElementById('update-btn').style.display = 'none';
    }

    function closeForm() { document.getElementById('productForm').style.display = 'none'; }

    async function loadProducts() {
      const res = await fetch('/products');
      const products = await res.json();
      window.productsList = products;
      const tbody = document.getElementById('products-body');
      tbody.innerHTML = '';

      let verifiedCount = 0;
      products.forEach(p => {
        if (p.verified) verifiedCount++;
        const row = document.createElement('tr');
        row.innerHTML = `
                    <td><strong>${p.name}</strong></td>
                    <td>KSh ${p.price_ksh}</td>
                    <td>${p.quantity} ${p.unit}</td>
                    <td><span class="badge ${p.verified ? 'badge-success' : 'badge-warning'}">${p.verified ? 'Verified' : 'Pending'}</span></td>
                    <td>
                        ${!p.verified ? `<button class="badge badge-success" style="border:none; cursor:pointer;" onclick="verifyProduct('${p.name}')">Verify</button>` : ''}
                        <button class="badge badge-warning" style="border:none; cursor:pointer;" onclick="editProduct(${p.id})">Edit</button>
                    </td>
                `;
        tbody.appendChild(row);
      });
      document.getElementById('verification-rate').textContent = Math.round((verifiedCount / products.length) * 100) + '%';
    }

    async function verifyProduct(name) {
      await fetch('/products/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      loadProducts();
    }

    async function loadOrders() {
      const res = await fetch('/orders');
      const orders = await res.json();
      const tbody = document.getElementById('orders-body');
      tbody.innerHTML = '';

      let totalRevenue = 0;
      orders.forEach(o => {
        const prod = window.productsList.find(p => p.name === o.product);
        if (prod) totalRevenue += (prod.price_ksh * o.quantity);

        const row = document.createElement('tr');
        row.innerHTML = `
                    <td>${o.buyer}</td>
                    <td>${o.product}</td>
                    <td>${o.quantity}</td>
                    <td><span class="badge ${o.status === 'Delivered' ? 'badge-success' : 'badge-warning'}">${o.status}</span></td>
                    <td>${o.order_date ? new Date(o.order_date).toLocaleDateString() : 'N/A'}</td>
                `;
        tbody.appendChild(row);
      });

      document.getElementById('total-revenue').textContent = 'KSh ' + totalRevenue.toLocaleString();
      document.getElementById('total-orders').textContent = orders.length;
    }

    function editProduct(id) {
      currentUpdateId = id;
      const p = window.productsList.find(item => item.id === id);
      document.getElementById('pname').value = p.name;
      document.getElementById('pprice').value = p.price_ksh;
      document.getElementById('pqty').value = p.quantity;
      document.getElementById('punit').value = p.unit;

      document.getElementById('form-title').textContent = 'Edit Product';
      document.getElementById('save-btn').style.display = 'none';
      document.getElementById('update-btn').style.display = 'block';
      document.getElementById('productForm').style.display = 'block';
    }

    async function saveProduct() {
      // ... Logic same as original app.js requirements ...
      // Using standard alert for now to keep implementation simple but clean
      alert('Sending to server...');
      closeForm();
    }

    async function downloadReports() {
      alert('Generating global report...');
      // ... Logic same as originalCSV generation ...
    }

    async function init() {
      await loadProducts();
      await loadOrders();
    }
    init();
  </script>
</body>

</html>