<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - JonaFarm</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7fb;
      margin: 0;
      padding: 0;
    }

    header {
      background: #1f3c88;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h2 {
      margin: 0;
      font-size: 24px;
    }

    .logout-btn {
      background: #ff0000;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .main {
      padding: 30px;
    }

    .welcome-msg {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    /* Stats Container */
    .stats-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: #fff;
      padding: 30px 20px;
      border-radius: 10px;
      flex: 1;
      text-align: center;
      min-width: 180px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .stat-card h4 {
      margin: 0 0 20px 0;
      color: #000;
      font-size: 16px;
      font-weight: bold;
    }

    .stat-card p {
      margin: 0;
      font-size: 18px;
      color: #000;
    }

    /* Buttons */
    .btn-group {
      margin-bottom: 30px;
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }

    .reports-btn {
      background: #6c63ff;
    }

    .add-btn {
      background: #28a745;
    }

    .update-btn {
      background: #ffae00;
      color: white;
    }

    .delete-btn {
      background: #ff0000;
      color: white;
    }

    .save-btn {
      background: #1f3c88;
      color: white;
      width: 100% !important;
      margin-bottom: 10px;
    }

    .cancel-btn {
      background: #ff0000;
      color: white;
      width: 100% !important;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-bottom: 30px;
    }

    th,
    td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: center;
    }

    th {
      background: #1f3c88;
      color: white;
    }

    .status-verified {
      color: #28a745;
      font-weight: bold;
    }

    /* Modal */
    #productForm {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .form-container {
      background: white;
      width: 400px;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .form-container h3 {
      margin: 0 0 20px 0;
      font-size: 20px;
    }

    .form-container input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .form-container label {
      display: block;
      margin-bottom: 10px;
    }

    #pimage {
      margin-bottom: 20px;
    }
  </style>
</head>

<body>

  <header>
    <h2>JonaFarm Admin Dashboard</h2>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <div class="main">
    <div class="welcome-msg" id="admin-name">Welcome, admin</div>

    <div class="section-title">Stats</div>
    <div class="stats-container">
      <div class="stat-card">
        <h4>Total Products</h4>
        <p id="total-products">0</p>
      </div>
      <div class="stat-card">
        <h4>Verified Products</h4>
        <p id="verified-products">0</p>
      </div>
      <div class="stat-card">
        <h4>Total Orders</h4>
        <p id="total-orders">0</p>
      </div>
      <div class="stat-card">
        <h4>Delivered Orders</h4>
        <p id="delivered-orders">0</p>
      </div>
      <div class="stat-card">
        <h4>Total Revenue</h4>
        <p id="total-revenue">KSh 0</p>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn reports-btn" onclick="downloadReports()">Download Reports</button>
      <button class="btn add-btn" onclick="openForm()">+ Add Product</button>
    </div>

    <div class="section-title">Products</div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Unit</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="products-body">
        <!-- Content loaded by JS -->
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="productForm" style="display: none;">
    <div class="form-container">
      <h3 id="form-title">Add Product</h3>
      <input id="pname" placeholder="Name">
      <input id="pprice" placeholder="Price">
      <input id="pqty" placeholder="Quantity">
      <input id="punit" placeholder="Unit">
      <input type="file" id="pimage" accept="image/*">
      <button class="btn save-btn" id="save-btn" onclick="saveProduct()">Save</button>
      <button class="btn save-btn" id="update-btn" style="display:none;" onclick="updateProduct()">Update</button>
      <button class="btn cancel-btn" onclick="closeForm()">Cancel</button>
    </div>
  </div>

  <script>
    let currentUpdateId = null;

    const admin = JSON.parse(localStorage.getItem('admin'));
    if (!admin) {
      // For demo/testing if admin object is missing
      document.getElementById('admin-name').textContent = "Welcome, admin";
    } else {
      document.getElementById('admin-name').textContent = "Welcome, " + admin.username;
    }

    function logout() { localStorage.removeItem('admin'); window.location.href = 'index.html'; }

    function openForm() {
      document.getElementById('productForm').style.display = 'flex';
      document.getElementById('form-title').textContent = 'Add Product';
      document.getElementById('save-btn').style.display = 'block';
      document.getElementById('update-btn').style.display = 'none';
      clearForm();
    }
    function closeForm() { document.getElementById('productForm').style.display = 'none'; }

    function clearForm() {
      document.getElementById('pname').value = '';
      document.getElementById('pprice').value = '';
      document.getElementById('pqty').value = '';
      document.getElementById('punit').value = '';
      document.getElementById('pimage').value = '';
      currentUpdateId = null;
    }

    async function loadProducts() {
      const res = await fetch('/products');
      const products = await res.json();
      window.productsList = products;
      const tbody = document.getElementById('products-body');
      tbody.innerHTML = '';

      products.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
        <td>${p.name}</td>
        <td>${p.price_ksh}</td>
        <td>${p.quantity}</td>
        <td>${p.unit || 'kg'}</td>
        <td><span class="status-verified">${p.verified ? 'âœ… Verified' : 'Not Verified'}</span></td>
        <td>
          <button class="btn update-btn" onclick="editProduct(${p.id})">Update</button>
          <button class="btn delete-btn" onclick="deleteProduct(${p.id})">Delete</button>
        </td>
      `;
        tbody.appendChild(row);
      });
      loadStats();
    }

    function editProduct(id) {
      currentUpdateId = id;
      const p = window.productsList.find(item => item.id === id);
      document.getElementById('pname').value = p.name;
      document.getElementById('pprice').value = p.price_ksh;
      document.getElementById('pqty').value = p.quantity;
      document.getElementById('punit').value = p.unit;

      document.getElementById('form-title').textContent = 'Update Product';
      document.getElementById('save-btn').style.display = 'none';
      document.getElementById('update-btn').style.display = 'block';
      document.getElementById('productForm').style.display = 'flex';
    }

    async function deleteProduct(id) {
      if (confirm('Are you sure?')) {
        const res = await fetch('/products/' + id, { method: 'DELETE' });
        loadProducts();
      }
    }

    async function saveProduct() {
      const name = document.getElementById('pname').value.trim();
      const price_ksh = document.getElementById('pprice').value.trim();
      const quantity = document.getElementById('pqty').value.trim();
      const unit = document.getElementById('punit').value.trim();
      const imageInput = document.getElementById('pimage');
      const imageFile = imageInput.files[0];

      if (!name || !price_ksh || !quantity || !unit || !imageFile) {
        alert("Please fill all fields and select an image!");
        return;
      }

      const reader = new FileReader();
      reader.onloadend = async () => {
        const res = await fetch('/products/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price_ksh: Number(price_ksh), quantity: Number(quantity), unit, image: reader.result })
        });
        if (res.ok) { closeForm(); loadProducts(); }
      };
      reader.readAsDataURL(imageFile);
    }

    async function updateProduct() {
      const name = document.getElementById('pname').value.trim();
      const price_ksh = document.getElementById('pprice').value.trim();
      const quantity = document.getElementById('pqty').value.trim();
      const unit = document.getElementById('punit').value.trim();
      const imageInput = document.getElementById('pimage');
      const imageFile = imageInput.files[0];

      const sendUpdate = async (imageData) => {
        const res = await fetch('/products/update/' + currentUpdateId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price_ksh: Number(price_ksh), quantity: Number(quantity), unit, image: imageData })
        });
        if (res.ok) { closeForm(); loadProducts(); }
      };

      if (imageFile) {
        const reader = new FileReader();
        reader.onloadend = async () => sendUpdate(reader.result);
        reader.readAsDataURL(imageFile);
      } else {
        sendUpdate(null);
      }
    }

    async function loadStats() {
      const pRes = await fetch('/products');
      const products = await pRes.json();
      const oRes = await fetch('/orders');
      const orders = await oRes.json();

      document.getElementById('total-products').textContent = products.length;
      document.getElementById('verified-products').textContent = products.filter(p => p.verified).length;
      document.getElementById('total-orders').textContent = orders.length;
      document.getElementById('delivered-orders').textContent = orders.filter(o => o.status === 'Delivered').length;

      let totalRev = 0;
      orders.forEach(o => {
        const p = products.find(prod => prod.name === o.product);
        if (p) totalRev += (p.price_ksh * o.quantity);
      });
      document.getElementById('total-revenue').textContent = 'KSh ' + totalRev;
    }

    function downloadReports() {
      alert('Generating report...');
    }

    loadProducts();
  </script>
</body>

</html>